<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Konya Kitabeleri + Chatbot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    canvas {
      margin-top: 20px;
    }
    #chat {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>Konya Kitabeleri</h1>
  <p>Kameradan görüntü alınarak kitabeler otomatik tanınır.</p>

  <!-- Chatbot Alanı -->
  <div id="chat">
    <input id="soru" type="text" placeholder="Bir soru yazın" style="width:300px;"/>
    <button onclick="gonder()">Sor</button>
  </div>

  <script>
    let classifier;
    let video;
    let label = "Model yükleniyor...";
    let bilgiler = {
      "Konevi Camii Kitabesi": "Bu mübarek mamure içindeki Sadreddin Konevi'nin türbesi ve vakıf kütüphanesi 673 yılında yapılmıştır.",
      "Haghia Elena Kilisesi Kitabesi": "Aya Elena tarafından 327 yılında kurulmuş ve 1833'te tamir edilmiştir.",
      "Abdül Mümin Mescidi Kitabesi": "Gıyaseddin Keyhüsrev döneminde 674 yılında Mahmud tarafından yenilenmiştir.",
      "Karatay Medresesi Kitabesi": "649 yılında Abdullah oğlu Karatay tarafından yaptırılmıştır."
    };

    function setup() {
      createCanvas(600, 500);
      let constraints = {
        video: { facingMode: { ideal: "environment" } },
        audio: false
      };
      video = createCapture(constraints);
      video.size(224, 224);
      video.hide();
      classifier = ml5.imageClassifier("https://ardaa83.github.io/konya-kitabeleri/model/model.json", video, modelReady);
    }

    function modelReady() {
      console.log("Model yüklendi.");
      classifyVideo();
    }

    function classifyVideo() {
      classifier.classify(gotResult);
    }

    function gotResult(error, results) {
      if (error) {
        console.error(error);
        return;
      }
      if (results && results[0]) {
        if (results[0].confidence < 0.6) {
          label = "Bilinmeyen Nesne";
        } else {
          label = results[0].label;
        }
      }
      classifyVideo();
    }

    function draw() {
      background(240);
      image(video, width / 2 - 112, height / 2 - 224, 224, 224);

      fill(0);
      textSize(20);
      textAlign(CENTER);
      text("Tahmin: " + label, width / 2, height - 160);

      if (bilgiler[label]) {
        fill(255);
        rectMode(CENTER);
        rect(width / 2, height - 120, 540, 120, 12);

        fill(0);
        textSize(16);
        textAlign(CENTER, CENTER);
        text(bilgiler[label], width / 2, height - 120, 500);
      }
    }

    async function gonder() {
      let mesaj = document.getElementById("soru").value;
      
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer 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", 
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: mesaj }]
        })
      });

      const data = await response.json();
      alert(data.choices[0].message.content);
    }
  </script>
</body>
</html>
